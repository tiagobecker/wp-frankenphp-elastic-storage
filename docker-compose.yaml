version: "3.9"

services:
  frankenphp:
    build: .
    restart: unless-stopped

    environment:
      SERVER_NAME: ${SERVER_NAME}

      DB_HOST: mariadb
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      WP_HOME: ${WP_HOME}
      WP_SITEURL: ${WP_SITEURL}

      REDIS_HOST: redis
      REDIS_PORT: 6379

      CLIENT_ID: ${CLIENT_ID}
      METAURL: ${METAURL}
      STORAGE_CAPACITY: ${STORAGE_CAPACITY}
      STORAGE_INODES: ${STORAGE_INODES}

    volumes:
      - /mnt/clients/{{CLIENT_ID}}:/app/public

    depends_on:
      mariadb:
        condition: service_started
      redis:
        condition: service_started

    deploy:
      resources:
        limits:
          cpus: ${WP_CPU_LIMIT}
          memory: ${WP_MEMORY_LIMIT}


  mariadb:
    image: mariadb:11.4
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}

    volumes:
      - mariadb_data:/var/lib/mysql

    deploy:
      resources:
        limits:
          cpus: ${DB_CPU_LIMIT}
          memory: ${DB_MEMORY_LIMIT}


  redis:
    image: redis:7-alpine
    restart: unless-stopped

    command: >
      redis-server
      --maxmemory ${REDIS_MAXMEMORY}
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no

    deploy:
      resources:
        limits:
          cpus: ${REDIS_CPU_LIMIT}
          memory: ${REDIS_MEMORY_LIMIT}

  quota-setter:
    image: alpine:latest
    command: sh -c "apk add --no-cache curl && curl -L https://github.com/juicedata/juicefs/releases/latest/download/juicefs-x86_64-unknown-linux-musl.tar.gz | tar -xz && mv juicefs /usr/local/bin/ && juicefs quota set ${METAURL} --path /mnt/clients/{{CLIENT_ID}} --capacity ${STORAGE_CAPACITY} --inodes ${STORAGE_INODES}"
    volumes:
      - /mnt/clients:/mnt/clients
    depends_on:
      - frankenphp


volumes:
  mariadb_data:
    driver: local
